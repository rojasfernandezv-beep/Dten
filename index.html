<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Checkout System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5',
                        'success': '#10b981', /* Green */
                        'danger': '#ef4444',  /* Red */
                        'warning': '#f59e0b', /* Amber */
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">
    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 sm:p-8">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-2 border-b pb-4">Device Checkout Hub</h1>
        
        <div id="error-message" class="hidden p-4 mb-4 text-sm text-danger bg-red-100 rounded-lg" role="alert"></div>
        
        <!-- User Information Form (Required for Checkout) -->
        <h2 class="text-2xl font-semibold text-gray-700 mb-3">Your Information for Checkout</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 p-4 border border-gray-200 rounded-xl bg-indigo-50/50">
            <div>
                <label for="user-name-input" class="block text-sm font-medium text-gray-700">Full Name</label>
                <input
                    type="text"
                    id="user-name-input"
                    placeholder="Jane Doe"
                    class="w-full p-2 border border-gray-300 rounded-lg mt-1 focus:ring-primary focus:border-primary"
                >
            </div>
            <div>
                <label for="user-email-input" class="block text-sm font-medium text-gray-700">Email Address</label>
                <input
                    type="email"
                    id="user-email-input"
                    placeholder="jane@company.com"
                    class="w-full p-2 border border-gray-300 rounded-lg mt-1 focus:ring-primary focus:border-primary"
                >
            </div>
            <div>
                <label for="return-date-input" class="block text-sm font-medium text-gray-700">Select a date</label>
                <input
                    type="date"
                    id="return-date-input"
                    class="w-full p-2 border border-gray-300 rounded-lg mt-1 focus:ring-primary focus:border-primary"
                    min="${new Date().toISOString().split('T')[0]}"
                >
            </div>
        </div>
        
        <!-- Device List Container -->
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Device Status</h2>

        <!-- NEW: Seed Data Button Container -->
        <div id="seed-data-container" class="mt-4 mb-8">
            <button id="seed-data-button" class="py-2 px-4 rounded-lg text-white font-medium transition duration-150 bg-warning hover:bg-amber-600 disabled:opacity-50">
                Seed Initial Device Data
            </button>
            <p class="text-sm text-gray-500 mt-2">Click this to add the 'DTEN' device to the system.</p>
        </div>
        <!-- END NEW -->

        <div id="device-list" class="space-y-4">
            <div id="loading-spinner" class="flex justify-center items-center py-10">
                <svg class="animate-spin h-8 w-8 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, updateDoc, doc, setLogLevel, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- HARDCODED ESSENTIALS (Using user's provided details for robustness) ---
        const ESSENTIAL_FIREBASE_DEFAULTS = {
            apiKey: "AIzaSyB52DNsoD0DutAWJCnQZUGHQYwpBqwB0CM", 
            projectId: "device-checkout-system",
        };
        // -------------------------------------------------------------------------

        // --- Initialization Constants ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
        
        let firebaseConfig = {};

        // 1. Attempt to parse environment config
        try {
            firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        } catch (e) {
            console.error("CRITICAL ERROR: Failed to parse __firebase_config. Using defaults.", e);
        }

        // 2. Guarantee the required fields using the fallback if missing
        if (!firebaseConfig.apiKey) {
            firebaseConfig.apiKey = ESSENTIAL_FIREBASE_DEFAULTS.apiKey;
            console.warn("API Key was missing from environment config. Using hardcoded fallback.");
        }
        if (!firebaseConfig.projectId) {
            firebaseConfig.projectId = ESSENTIAL_FIREBASE_DEFAULTS.projectId;
            console.warn("Project ID was missing from environment config. Using hardcoded fallback.");
        }
        
        const DOM = {
            error: document.getElementById('error-message'),
            list: document.getElementById('device-list'),
            spinner: document.getElementById('loading-spinner'),
            nameInput: document.getElementById('user-name-input'),
            emailInput: document.getElementById('user-email-input'),
            returnDateInput: document.getElementById('return-date-input'),
            seedContainer: document.getElementById('seed-data-container'),
            seedButton: document.getElementById('seed-data-button'),
        };

        let db, auth, userId = null;
        let devicesCollectionRef = null;
        let currentDevices = [];
        
        // --- Utility Functions ---

        function displayError(message) {
            console.error(message);
            DOM.error.textContent = message;
            DOM.error.classList.remove('hidden');
        }

        function clearError() {
            DOM.error.classList.add('hidden');
            DOM.error.textContent = '';
        }

        function getUserInfo() {
            const name = DOM.nameInput.value.trim();
            const email = DOM.emailInput.value.trim();
            const returnDate = DOM.returnDateInput.value;
            
            if (!name || !email || !returnDate) {
                displayError("Please enter your Full Name, Email, and the Expected Return Date to check out a device.");
                return null;
            }
            return { name, email, returnDate };
        }
        
        // --- Firestore Operations ---

        /**
         * Adds initial devices to the Firestore collection.
         * Now adds a single 'DTEN' device for testing.
         */
        async function seedInitialData() {
            if (!devicesCollectionRef) return displayError("Database not initialized for seeding.");

            DOM.seedButton.disabled = true;
            DOM.seedButton.textContent = 'Seeding... Please wait.';

            // Define the single device requested by the user.
            const initialDevice = { 
                name: "DTEN", 
                status: "available" 
            };
            // Use 'DTEN' as the fixed document ID as requested.
            const deviceId = "DTEN"; 

            try {
                console.log("Starting database seeding with DTEN device...");
                
                // Use setDoc to create/overwrite the document with the fixed ID 'DTEN'
                const docRef = doc(db, devicesCollectionRef.path, deviceId); 
                await setDoc(docRef, initialDevice, { merge: true });
                
                console.log("Database seeding complete. DTEN added.");
                clearError();
            } catch (e) {
                displayError(`Error seeding data: ${e.message}`);
            } finally {
                // The onSnapshot listener will automatically re-render and hide the button
                // if the operation was successful.
                DOM.seedButton.disabled = false;
                DOM.seedButton.textContent = 'Seed Initial Device Data';
            }
        }
        
        async function updateDeviceStatus(deviceId, status) {
            if (status === 'checked_out' && !userId) {
                return displayError("Authentication is pending. Please wait a moment before checking out a device.");
            }
            if (!devicesCollectionRef) return displayError("Database not initialized.");
            
            const isCheckingOut = status === 'checked_out';
            let updateData = { status: status };
            
            if (isCheckingOut) {
                const userInfo = getUserInfo();
                if (!userInfo) return;
                
                updateData.checkedOutBy = userId;
                updateData.checkedOutByUserName = userInfo.name;
                // FIX: Store the user email
                updateData.checkedOutByUserEmail = userInfo.email; 
                updateData.expectedReturnDate = userInfo.returnDate;
                updateData.checkedOutAt = new Date().toISOString();
                
            } else {
                updateData.checkedOutBy = null;
                updateData.checkedOutByUserName = null;
                // FIX: Ensure email field is also cleared on check-in
                updateData.checkedOutByUserEmail = null; 
                updateData.expectedReturnDate = null;
                updateData.checkedOutAt = null;
            }

            try {
                const docRef = doc(db, devicesCollectionRef.path, deviceId);
                await updateDoc(docRef, updateData);
                clearError();
            } catch (e) {
                displayError(`Error updating device: ${e.message}`);
            }
        }

        // --- Rendering Logic ---

        function createDeviceCard(device) {
            const isCheckedOut = device.status === 'checked_out';
            const isCheckedOutByMe = isCheckedOut && device.checkedOutBy === userId;
            const isPastDue = isCheckedOut && device.expectedReturnDate && (new Date(device.expectedReturnDate) < new Date());

            const statusColor = isPastDue ? 'bg-warning' : (isCheckedOut ? 'bg-danger' : 'bg-success');
            const statusText = isPastDue ? 'OVERDUE' : (isCheckedOut ? 'Checked Out' : 'Available');
            
            const buttonText = isCheckedOutByMe ? 'Check In' : 'Check Out';
            const buttonClass = isCheckedOutByMe ? 'bg-danger hover:bg-red-600' : 'bg-primary hover:bg-primary-600';
            const buttonDisabled = isCheckedOut && !isCheckedOutByMe && userId !== null; 

            const card = document.createElement('div');
            card.className = 'p-5 bg-white border border-gray-200 rounded-xl shadow-lg flex flex-col sm:flex-row items-start sm:items-center justify-between transition duration-200';
            
            const statusIndicator = `
                <span class="w-3 h-3 rounded-full ${statusColor} mr-4 mt-2 flex-shrink-0" aria-label="Device Status"></span>
                <div class="flex flex-col">
                    <span class="text-xl font-bold text-gray-800">${device.name}</span>
                    <span class="text-sm font-medium text-gray-600 flex items-center">
                        Status: <span class="ml-1 font-bold ${isCheckedOut ? (isPastDue ? 'text-warning' : 'text-danger') : 'text-success'}">${statusText}</span>
                    </span>
                    ${isCheckedOut ? `
                        <div class="text-sm text-gray-600 mt-2 p-3 border border-gray-100 rounded-lg bg-gray-50 max-w-sm">
                            <p><span class="font-semibold">Checked Out By:</span> ${device.checkedOutByUserName || 'Another User'}</p>
                            ${device.checkedOutByUserEmail ? `<p><span class="font-semibold">Email:</span> ${device.checkedOutByUserEmail}</p>` : ''}
                        </div>
                    ` : ''}
                </div>
            `;
            
            const buttonSection = `
                <button
                    id="btn-${device.id}"
                    class="py-2 px-4 rounded-lg text-white font-medium transition duration-150 transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed ${buttonClass} mt-3 sm:mt-0"
                    ${buttonDisabled ? 'disabled' : ''}
                >
                    ${buttonText}
                </button>
            `;

            card.innerHTML = `<div class="flex items-start mb-3 sm:mb-0">${statusIndicator}</div> ${buttonSection}`;

            const button = card.querySelector(`#btn-${device.id}`);
            button.addEventListener('click', () => {
                if (userId === null) {
                    displayError("Authentication is currently pending. Please wait a moment for the connection to finalize.");
                    if (isCheckedOutByMe) return; 
                }

                if (isCheckedOutByMe) {
                    const currentUserName = DOM.nameInput.value.trim();
                    const requiredUserName = device.checkedOutByUserName;

                    if (!currentUserName) {
                         displayError(`To check in "${device.name}", please **re-enter your full name** in the "Your Information" section above to confirm your return.`);
                         return;
                    }
                    
                    if (currentUserName === requiredUserName) {
                        updateDeviceStatus(device.id, 'available');
                    } else {
                        displayError(`Check-in failed for "${device.name}". The name you entered ("${currentUserName}") does not match the name recorded for this checkout ("${requiredUserName}").`);
                    }

                } else if (!isCheckedOut) {
                    updateDeviceStatus(device.id, 'checked_out');
                } else {
                    displayError(`Device "${device.name}" is not available for checkout. It is currently checked out by ${device.checkedOutByUserName || 'another user'}.`);
                }
            });

            return card;
        }

        function renderDeviceList(devices) {
            DOM.list.innerHTML = '';
            
            const spinner = document.getElementById('loading-spinner');
            if(spinner) spinner.remove();

            if (devices.length === 0) {
                const message = document.createElement('div');
                message.className = 'text-center text-gray-500 py-10 italic bg-gray-50 rounded-lg border border-dashed border-gray-200';
                message.innerHTML = `
                    <p class="font-semibold text-lg mb-2">No Devices Found</p>
                    <p class="mb-4">Click the button above to seed the system with the 'DTEN' device.</p>
                    <p class="text-xs">If you already added data and still see this, check your Firebase Security Rules for read access.</p>
                `;
                DOM.list.appendChild(message);
                
                // Show the seed button when the list is empty
                DOM.seedContainer.classList.remove('hidden');
                return;
            }
            
            // Hide the seed button when the list is populated
            DOM.seedContainer.classList.add('hidden');
            
            devices.sort((a, b) => {
                const statusA = a.status;
                const statusB = b.status;
                
                if (statusA === 'available' && statusB !== 'available') return -1;
                if (statusB === 'available' && statusA !== 'available') return 1;

                const isADue = a.expectedReturnDate && (new Date(a.expectedReturnDate) < new Date());
                const isBDue = b.expectedReturnDate && (new Date(b.expectedReturnDate) < new Date());

                if (isADue && !isBDue) return -1;
                if (isBDue && !isADue) return 1;

                return 0;
            }); 

            devices.forEach(device => DOM.list.appendChild(createDeviceCard(device)));
        }


        // --- Main Initialization and Authentication ---

        async function initFirebase() {
            if (!firebaseConfig.projectId || !firebaseConfig.apiKey) {
                const spinner = document.getElementById('loading-spinner');
                if(spinner) spinner.remove();
                return displayError("CRITICAL: Final configuration is still missing Project ID or API Key. Cannot proceed.");
            }
            
            // Attach seed button listener immediately
            DOM.seedButton.addEventListener('click', seedInitialData);

            console.log("Firebase Initialization: Using Project ID:", firebaseConfig.projectId);

            try {
                setLogLevel('debug');
                
                const app = initializeApp(firebaseConfig);
                
                db = getFirestore(app);
                auth = getAuth(app);
                
                await setPersistence(auth, browserSessionPersistence);
                
                // 1. Setup Firestore Collection and Listener
                const collectionPath = `artifacts/${appId}/public/data/devices`;
                devicesCollectionRef = collection(db, collectionPath);
                startRealtimeListener();
                
                // 2. Perform Authentication
                const authenticateUser = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                            console.log("Authentication attempted with custom token.");
                        } else {
                            await signInAnonymously(auth);
                            console.log("Authentication attempted anonymously.");
                        }
                    } catch(e) {
                        console.error("Authentication failed:", e);
                    }
                };
                authenticateUser();

                // 3. Set up Auth State Observer
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("Auth State Changed: User is authenticated with ID:", userId); 
                    } else {
                        userId = null;
                        console.log("Auth State Changed: User is not authenticated.");
                    }
                    clearError();
                });

            } catch (e) {
                const spinner = document.getElementById('loading-spinner');
                if(spinner) spinner.remove();
                displayError(`Application Error: Cannot initialize database or Firebase services. Details: ${e.message}`);
            }
        }
        
        function startRealtimeListener() {
            if (!devicesCollectionRef) return;
            
            const devicesQuery = query(devicesCollectionRef);
            
            onSnapshot(devicesQuery, (snapshot) => {
                const devices = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                }));

                currentDevices = devices; 
                renderDeviceList(devices);
            }, (err) => {
                displayError(`Real-time Listener Error: ${err.message}. If the list is empty, ensure your Firebase Security Rules allow 'read' access for authenticated users.`);
            });
        }

        // Start the application
        window.onload = initFirebase;
    </script>
</body>
</html>


