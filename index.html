<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Checkout System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5',
                        'success': '#10b981', /* Green */
                        'danger': '#ef4444',  /* Red */
                        'warning': '#f59e0b', /* Amber */
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">
    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 sm:p-8">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-2">Device Checkout Hub</h1>
        <p id="user-info" class="text-sm text-gray-500 mb-6 border-b pb-4">
            <span class="font-semibold text-primary">Connecting...</span>
        </p>

        <div id="error-message" class="hidden p-4 mb-4 text-sm text-danger bg-red-100 rounded-lg" role="alert"></div>
        
        <!-- User Information Form (Required for Checkout) -->
        <h2 class="text-2xl font-semibold text-gray-700 mb-3">Your Information for Checkout</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 p-4 border border-gray-200 rounded-xl bg-indigo-50/50">
            <div>
                <label for="user-name-input" class="block text-sm font-medium text-gray-700">Full Name</label>
                <input
                    type="text"
                    id="user-name-input"
                    placeholder="Jane Doe"
                    class="w-full p-2 border border-gray-300 rounded-lg mt-1 focus:ring-primary focus:border-primary"
                >
            </div>
            <div>
                <label for="user-email-input" class="block text-sm font-medium text-gray-700">Email Address</label>
                <input
                    type="email"
                    id="user-email-input"
                    placeholder="jane@company.com"
                    class="w-full p-2 border border-gray-300 rounded-lg mt-1 focus:ring-primary focus:border-primary"
                >
            </div>
            <div>
                <label for="return-date-input" class="block text-sm font-medium text-gray-700">Expected Return Date</label>
                <input
                    type="date"
                    id="return-date-input"
                    class="w-full p-2 border border-gray-300 rounded-lg mt-1 focus:ring-primary focus:border-primary"
                    min="${new Date().toISOString().split('T')[0]}"
                >
            </div>
        </div>
        
        <!-- Device List Container -->
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Device Status</h2>
        <div id="device-list" class="space-y-4">
            <div id="loading-spinner" class="flex justify-center items-center py-10">
                <svg class="animate-spin h-8 w-8 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, updateDoc, doc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION FOR EXTERNAL HOSTING ---
        // This object has been replaced with your actual configuration keys.
        const EXTERNAL_FIREBASE_CONFIG = {
          apiKey: "AIzaSyB52DNsoD0DutAWJCnQZUGHQYwpBqwB0CM",
          authDomain: "device-checkout-system.firebaseapp.com",
          projectId: "device-checkout-system",
          storageBucket: "device-checkout-system.firebasestorage.app",
          messagingSenderId: "552885197205",
          appId: "1:552885197205:web:2bfd659420f6442311be9c",
          measurementId: "G-1R94ZGT22T"
        };
        
        // --- Initialization Constants ---
        const EXTERNAL_APP_ID = 'external-device-tracker';
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : EXTERNAL_APP_ID;
        let firebaseConfig;
        try {
            // Priority 1: Use Canvas global config
            firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : EXTERNAL_FIREBASE_CONFIG;
        } catch (e) {
            console.error("Failed to parse __firebase_config. Using external fallback.", e);
            firebaseConfig = EXTERNAL_FIREBASE_CONFIG;
        }
        
        const DOM = {
            info: document.getElementById('user-info'),
            error: document.getElementById('error-message'),
            list: document.getElementById('device-list'),
            spinner: document.getElementById('loading-spinner'),
            nameInput: document.getElementById('user-name-input'),
            emailInput: document.getElementById('user-email-input'),
            returnDateInput: document.getElementById('return-date-input'),
        };

        let db, auth, userId = null;
        let devicesCollectionRef = null;
        
        // --- Utility Functions ---

        function displayError(message) {
            console.error(message);
            DOM.error.textContent = message;
            DOM.error.classList.remove('hidden');
        }

        function clearError() {
            DOM.error.classList.add('hidden');
            DOM.error.textContent = '';
        }

        function getUserInfo() {
            const name = DOM.nameInput.value.trim();
            const email = DOM.emailInput.value.trim();
            const returnDate = DOM.returnDateInput.value;
            
            if (!name || !email || !returnDate) {
                displayError("Please enter your Full Name, Email, and the Expected Return Date to check out a device.");
                return null;
            }
            return { name, email, returnDate };
        }
        
        // --- Firestore Operations ---
        
        async function updateDeviceStatus(deviceId, status) {
            if (!devicesCollectionRef) return displayError("Database not initialized.");
            
            const isCheckingOut = status === 'checked_out';
            let updateData = { status: status };
            
            if (isCheckingOut) {
                const userInfo = getUserInfo();
                if (!userInfo) return; // Error handled by getUserInfo
                
                updateData.checkedOutBy = userId;
                updateData.checkedOutByUserName = userInfo.name;
                updateData.checkedOutByUserEmail = userInfo.email;
                updateData.expectedReturnDate = userInfo.returnDate; // New field
                updateData.checkedOutAt = new Date().toISOString();
                
            } else {
                // Check In logic: Clear all checkout fields
                updateData.checkedOutBy = null;
                updateData.checkedOutByUserName = null;
                updateData.checkedOutByUserEmail = null;
                updateData.expectedReturnDate = null; // Clear new field
                updateData.checkedOutAt = null;
                
                // Clear the local form fields for the next checkout
                DOM.nameInput.value = '';
                DOM.emailInput.value = '';
                DOM.returnDateInput.value = '';
            }

            try {
                const docRef = doc(db, devicesCollectionRef.path, deviceId);
                await updateDoc(docRef, updateData);
                clearError();
            } catch (e) {
                displayError(`Error updating device: ${e.message}`);
            }
        }

        // --- Rendering Logic ---

        function createDeviceCard(device) {
            const isCheckedOut = device.status === 'checked_out';
            const isCheckedOutByMe = isCheckedOut && device.checkedOutBy === userId;
            const isPastDue = isCheckedOut && device.expectedReturnDate && (new Date(device.expectedReturnDate) < new Date());

            const statusColor = isPastDue ? 'bg-warning' : (isCheckedOut ? 'bg-danger' : 'bg-success');
            const statusText = isPastDue ? 'OVERDUE' : (isCheckedOut ? 'Checked Out' : 'Available');
            
            const buttonText = isCheckedOutByMe ? 'Check In' : 'Check Out';
            const buttonClass = isCheckedOutByMe ? 'bg-danger hover:bg-red-600' : 'bg-primary hover:bg-primary-600';
            // Disable button if it's checked out by someone else
            const buttonDisabled = isCheckedOut && !isCheckedOutByMe; 

            const card = document.createElement('div');
            card.className = 'p-5 bg-white border border-gray-200 rounded-xl shadow-lg flex flex-col sm:flex-row items-start sm:items-center justify-between transition duration-200';
            
            const dateDisplay = device.expectedReturnDate 
                ? new Date(device.expectedReturnDate).toLocaleDateString()
                : 'N/A';
                
            const statusIndicator = `
                <span class="w-3 h-3 rounded-full ${statusColor} mr-4 mt-2 flex-shrink-0" aria-label="Device Status"></span>
                <div class="flex flex-col">
                    <span class="text-xl font-bold text-gray-800">${device.name}</span>
                    <span class="text-sm font-medium text-gray-600 flex items-center">
                        Status: <span class="ml-1 font-bold ${isCheckedOut ? (isPastDue ? 'text-warning' : 'text-danger') : 'text-success'}">${statusText}</span>
                    </span>
                    ${isCheckedOut ? `
                        <div class="text-sm text-gray-600 mt-2 p-3 border border-gray-100 rounded-lg bg-gray-50 max-w-sm">
                            <p><span class="font-semibold">Checked Out By:</span> ${device.checkedOutByUserName || 'N/A'}</p>
                            <p><span class="font-semibold">Expected Return:</span> <span class="${isPastDue ? 'text-warning font-extrabold' : 'text-gray-700'}">${dateDisplay}</span></p>
                            <p><span class="font-semibold">Email:</span> <a href="mailto:${device.checkedOutByUserEmail}" class="text-primary hover:underline">${device.checkedOutByUserEmail || 'N/A'}</a></p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            const buttonSection = `
                <button
                    id="btn-${device.id}"
                    class="py-2 px-4 rounded-lg text-white font-medium transition duration-150 transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed ${buttonClass} mt-3 sm:mt-0"
                    ${buttonDisabled ? 'disabled' : ''}
                >
                    ${buttonText}
                </button>
            `;

            card.innerHTML = `<div class="flex items-start mb-3 sm:mb-0">${statusIndicator}</div> ${buttonSection}`;


            // Attach click handler
            const button = card.querySelector(`#btn-${device.id}`);
            button.addEventListener('click', () => {
                if (!userId) return displayError("Authentication is pending. Please wait or refresh.");

                if (isCheckedOutByMe) {
                    // Case 1: Check In
                    updateDeviceStatus(device.id, 'available');
                } else if (!isCheckedOut) {
                    // Case 2: Check Out (Device is available)
                    updateDeviceStatus(device.id, 'checked_out');
                } else {
                    // Case 3 (NEW): Attempting to Check Out a device that is already checked out by someone else
                    displayError(`Device "${device.name}" is not available for checkout. It is currently checked out by ${device.checkedOutByUserName || 'another user'}.`);
                }
            });

            return card;
        }

        function renderDeviceList(devices) {
            DOM.list.innerHTML = '';
            
            if (devices.length === 0) {
                DOM.spinner.remove();
                const message = document.createElement('p');
                message.className = 'text-center text-gray-500 py-10 italic bg-gray-50 rounded-lg border border-dashed border-gray-200';
                message.textContent = userId 
                    ? "No devices found in the system." 
                    : "Waiting for authentication...";
                DOM.list.appendChild(message);
                return;
            }
            
            // Sort: Available first, then Checked Out, then Overdue
            devices.sort((a, b) => {
                const statusA = a.status;
                const statusB = b.status;
                
                if (statusA === 'available' && statusB !== 'available') return -1;
                if (statusB === 'available' && statusA !== 'available') return 1;

                // Secondary sort: Overdue devices should be near the top
                const isADue = a.expectedReturnDate && (new Date(a.expectedReturnDate) < new Date());
                const isBDue = b.expectedReturnDate && (new Date(b.expectedReturnDate) < new Date());

                if (isADue && !isBDue) return -1;
                if (isBDue && !isADue) return 1;

                return 0; // Maintain existing order otherwise
            }); 

            devices.forEach(device => DOM.list.appendChild(createDeviceCard(device)));
        }


        // --- Main Initialization and Authentication ---

        async function initFirebase() {
            if (!firebaseConfig) {
                return displayError("Firebase configuration is missing.");
            }

            try {
                // setLogLevel('Debug'); // Uncomment this for console debugging
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Authentication Logic (Retained from previous fix)
                const authenticateUser = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch(e) {
                        console.error("Anonymous Sign-in failed:", e);
                    }
                };
                authenticateUser();

                // Set up Auth State Observer
                onAuthStateChanged(auth, (user) => {
                    DOM.spinner.remove();
                    if (user) {
                        userId = user.uid;
                        // MANDATORY PUBLIC Firestore path for shared resources
                        const collectionPath = `artifacts/${appId}/public/data/devices`;
                        devicesCollectionRef = collection(db, collectionPath);
                        
                        DOM.info.innerHTML = `<span class="font-semibold text-primary">User ID:</span> ${userId}`;
                        clearError();
                        
                        // Start real-time data listener
                        startRealtimeListener();
                    } else {
                        userId = null;
                        DOM.info.innerHTML = `<span class="font-semibold text-danger">Not signed in. Cannot interact with devices.</span>`;
                        renderDeviceList([]);
                    }
                });

            } catch (e) {
                DOM.spinner.remove();
                displayError(`Configuration Error: Please verify your API Key and other Firebase settings are correct. Details: ${e.message}`);
            }
        }
        
        function startRealtimeListener() {
            if (!devicesCollectionRef) return;
            
            const devicesQuery = query(devicesCollectionRef);
            
            onSnapshot(devicesQuery, (snapshot) => {
                const devices = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                }));

                renderDeviceList(devices);
            }, (err) => {
                displayError(`Real-time Listener Error: ${err.message}`);
            });
        }

        // Start the application
        window.onload = initFirebase;
    </script>
</body>
</html>
