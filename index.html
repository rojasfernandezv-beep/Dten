<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unlimited Reservation Manager</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and better feel */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        .container {
            max-width: 900px;
        }
        /* Custom scrollbar for the reservations list */
        #reservations-list-container::-webkit-scrollbar {
            width: 8px;
        }
        #reservations-list-container::-webkit-scrollbar-thumb {
            background-color: #a0aec0;
            border-radius: 4px;
        }
        #reservations-list-container::-webkit-scrollbar-track {
            background-color: #e2e8f0;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#4f46e5',
                        'secondary': '#60a5fa',
                    },
                }
            }
        }
    </script>
</head>
<body class="min-h-screen p-4 sm:p-8 flex flex-col items-center">

    <div class="container w-full bg-white shadow-xl rounded-xl p-6 lg:p-10">
        <h1 class="text-3xl font-extrabold text-primary mb-2 text-center">
            Unlimited Reservation Manager
        </h1>
        <p class="text-gray-500 mb-6 text-center">
            Signed in as User ID: <span id="user-id" class="font-mono text-xs bg-gray-100 p-1 rounded">Loading...</span>
        </p>

        <!-- Reservation Form -->
        <div class="mb-8 p-4 bg-indigo-50 rounded-lg border border-indigo-200">
            <h2 class="text-2xl font-semibold text-primary mb-4">Make a New Reservation</h2>
            <form id="reservation-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" id="name" placeholder="Name" required
                       class="p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">

                <input type="date" id="date" required
                       class="p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">

                <input type="time" id="time" required
                       class="p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary">

                <button type="submit"
                        class="md:col-span-2 bg-primary text-white font-bold py-3 px-4 rounded-lg shadow-lg hover:bg-indigo-700 transition duration-300 transform hover:scale-[1.01]">
                    Book Now
                </button>
            </form>
            <div id="message-box" class="mt-4 p-3 rounded-lg text-sm hidden"></div>
        </div>

        <!-- Reservations List -->
        <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Future Reservations</h2>
        <div id="loading-indicator" class="text-center text-gray-500 p-4">
            <svg class="animate-spin h-5 w-5 text-primary inline-block mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Loading reservations...
        </div>
        <div id="reservations-list-container" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
            <!-- Reservations will be rendered here -->
        </div>
    </div>

    <script type="module">
        // Mandatory Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, where, onSnapshot, serverTimestamp, doc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth;
        let currentUserId = 'anonymous';

        const form = document.getElementById('reservation-form');
        const reservationsListContainer = document.getElementById('reservations-list-container');
        const messageBox = document.getElementById('message-box');
        const userIdDisplay = document.getElementById('user-id');
        const loadingIndicator = document.getElementById('loading-indicator');

        // Function to display messages (instead of alert)
        function showMessage(text, isError = false) {
            messageBox.textContent = text;
            messageBox.classList.remove('hidden');
            if (isError) {
                messageBox.className = 'mt-4 p-3 rounded-lg text-sm bg-red-100 text-red-700';
            } else {
                messageBox.className = 'mt-4 p-3 rounded-lg text-sm bg-green-100 text-green-700';
            }
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        // 1. Initialize Firebase and Auth
        async function initializeFirebase() {
            if (!firebaseConfig) {
                console.error("Firebase config is missing.");
                return;
            }

            try {
                // setLogLevel('Debug'); // Uncomment for debugging
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Authenticate the user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = currentUserId;
                        // Once authenticated, start listening for data
                        setupReservationListener();
                    } else {
                        currentUserId = 'anonymous';
                        userIdDisplay.textContent = 'Anonymous (Data will be private)';
                        showMessage("Authentication failed. Using anonymous ID.", true);
                    }
                });
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessage(`Firebase initialization failed: ${error.message}`, true);
            }
        }

        /**
         * 2. Adds a new reservation to Firestore.
         * There are no arbitrary limits here; it will add a document every time it's called.
         */
        async function addReservation(name, date, time) {
            if (!db) {
                showMessage("Database not initialized. Please wait.", true);
                return;
            }

            const reservationRef = collection(
                db,
                // Using a public data path for a shared reservation list
                `artifacts/${appId}/public/data/reservations`
            );

            try {
                const newReservation = {
                    name: name,
                    reservationDate: date,
                    reservationTime: time,
                    createdAt: serverTimestamp(),
                    userId: currentUserId,
                    // Combine date and time into an ISO string for easy future sorting/filtering
                    dateTimeISO: `${date}T${time}:00`
                };

                // Add the document. This is the core action that allows for unlimited reservations.
                await addDoc(reservationRef, newReservation);

                showMessage("Reservation successfully booked!");
                form.reset();

            } catch (e) {
                console.error("Error adding reservation: ", e);
                showMessage(`Error booking reservation: ${e.message}`, true);
            }
        }

        // 3. Set up real-time listener for reservations
        function setupReservationListener() {
            const reservationRef = collection(
                db,
                `artifacts/${appId}/public/data/reservations`
            );

            // Filter out reservations that are in the past and sort by date/time
            const nowISO = new Date().toISOString().slice(0, 16);
            const q = query(
                reservationRef,
                // Only show future reservations
                where("dateTimeISO", ">=", nowISO)
            );

            // Use onSnapshot for real-time updates
            onSnapshot(q, (snapshot) => {
                loadingIndicator.classList.add('hidden');
                reservationsListContainer.innerHTML = ''; // Clear existing list

                if (snapshot.empty) {
                    reservationsListContainer.innerHTML = `
                        <p class="text-center text-gray-500 p-8 bg-gray-50 rounded-lg">
                            No future reservations found. Book one above!
                        </p>
                    `;
                    return;
                }

                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const reservationItem = document.createElement('div');
                    const isOwner = data.userId === currentUserId;

                    reservationItem.className = `
                        flex justify-between items-center p-4 rounded-lg shadow-md transition duration-200
                        ${isOwner ? 'bg-indigo-100 border-l-4 border-primary' : 'bg-white border'}
                    `;

                    // Format date for display
                    const dateObj = new Date(data.dateTimeISO);
                    const formattedDate = dateObj.toLocaleDateString(undefined, {
                        weekday: 'short', year: 'numeric', month: 'short', day: 'numeric'
                    });
                    const formattedTime = dateObj.toLocaleTimeString(undefined, {
                        hour: '2-digit', minute: '2-digit'
                    });

                    reservationItem.innerHTML = `
                        <div>
                            <p class="text-lg font-bold text-gray-800">${data.name}</p>
                            <p class="text-sm text-gray-600">${formattedDate} at ${formattedTime}</p>
                            ${isOwner ? '<span class="text-xs text-primary font-medium"> (Your Reservation)</span>' : ''}
                        </div>
                        <button data-doc-id="${doc.id}"
                                class="delete-btn text-red-500 hover:text-red-700 font-semibold text-sm py-1 px-3 rounded transition duration-200 ${isOwner ? 'hover:bg-red-100' : 'opacity-50 cursor-not-allowed'}"
                                ${isOwner ? '' : 'disabled'}>
                            Cancel
                        </button>
                    `;
                    reservationsListContainer.appendChild(reservationItem);
                });

                // Attach delete event listeners
                reservationsListContainer.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', handleDeleteReservation);
                });
            }, (error) => {
                console.error("Error setting up reservation listener:", error);
                loadingIndicator.classList.add('hidden');
                reservationsListContainer.innerHTML = `<p class="text-red-500">Error loading data: ${error.message}</p>`;
            });
        }

        async function handleDeleteReservation(event) {
            if (!db) return;
            const docId = event.target.getAttribute('data-doc-id');
            if (!docId) return;

            // Simple confirmation message display (not a blocking prompt)
            if (!confirm("Are you sure you want to cancel this reservation?")) {
                return;
            }

            const docRef = doc(db, `artifacts/${appId}/public/data/reservations`, docId);
            try {
                await deleteDoc(docRef);
                showMessage("Reservation cancelled successfully!");
            } catch (e) {
                console.error("Error deleting reservation: ", e);
                showMessage(`Error cancelling reservation: ${e.message}`, true);
            }
        }

        // 4. Form Submission Handler
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const name = document.getElementById('name').value.trim();
            const date = document.getElementById('date').value;
            const time = document.getElementById('time').value;

            // Simple date validation to prevent past reservations
            const reservationDateTime = new Date(`${date}T${time}:00`);
            if (reservationDateTime <= new Date()) {
                showMessage("Please select a date and time in the future.", true);
                return;
            }

            addReservation(name, date, time);
        });

        // Start the application
        window.onload = initializeFirebase;

    </script>
</body>
</html>


