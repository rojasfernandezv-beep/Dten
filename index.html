<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Checkout System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary': '#4f46e5',
                        'success': '#10b981', /* Green */
                        'danger': '#ef4444',  /* Red */
                        'warning': '#f59e0b', /* Amber */
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">
    <div class="max-w-4xl mx-auto bg-white shadow-2xl rounded-xl p-6 sm:p-8">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-2 border-b pb-4">Device Checkout Hub</h1>
        <!-- Removed the visible user-info/connection status area (id="user-info") -->

        <div id="error-message" class="hidden p-4 mb-4 text-sm text-danger bg-red-100 rounded-lg" role="alert"></div>
        
        <!-- User Information Form (Required for Checkout) -->
        <h2 class="text-2xl font-semibold text-gray-700 mb-3">Your Information for Checkout</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8 p-4 border border-gray-200 rounded-xl bg-indigo-50/50">
            <div>
                <label for="user-name-input" class="block text-sm font-medium text-gray-700">Full Name</label>
                <input
                    type="text"
                    id="user-name-input"
                    placeholder="Jane Doe"
                    class="w-full p-2 border border-gray-300 rounded-lg mt-1 focus:ring-primary focus:border-primary"
                >
            </div>
            <div>
                <label for="user-email-input" class="block text-sm font-medium text-gray-700">Email Address</label>
                <input
                    type="email"
                    id="user-email-input"
                    placeholder="jane@company.com"
                    class="w-full p-2 border border-gray-300 rounded-lg mt-1 focus:ring-primary focus:border-primary"
                >
            </div>
            <div>
                <!-- Label changed to "Select a date" per request -->
                <label for="return-date-input" class="block text-sm font-medium text-gray-700">Select a date</label>
                <input
                    type="date"
                    id="return-date-input"
                    class="w-full p-2 border border-gray-300 rounded-lg mt-1 focus:ring-primary focus:border-primary"
                    min="${new Date().toISOString().split('T')[0]}"
                >
            </div>
        </div>
        
        <!-- Device List Container -->
        <h2 class="text-2xl font-semibold text-gray-700 mb-4">Device Status</h2>
        <div id="device-list" class="space-y-4">
            <div id="loading-spinner" class="flex justify-center items-center py-10">
                <svg class="animate-spin h-8 w-8 text-primary" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Imports and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // NOTE: Added signInWithCustomToken to imports
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, updateDoc, doc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Initialization Constants (Relying ONLY on Canvas Globals) ---
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : '';
        
        let firebaseConfig;
        try {
            // MANDATORY: Parse the global config provided by the Canvas environment.
            firebaseConfig = JSON.parse(__firebase_config);
        } catch (e) {
            console.error("CRITICAL ERROR: Failed to parse __firebase_config. Environment issue suspected.", e);
            // Use an empty object as a safe, non-fatal fallback.
            firebaseConfig = {}; 
        }
        
        const DOM = {
            error: document.getElementById('error-message'),
            list: document.getElementById('device-list'),
            spinner: document.getElementById('loading-spinner'),
            nameInput: document.getElementById('user-name-input'),
            emailInput: document.getElementById('user-email-input'),
            returnDateInput: document.getElementById('return-date-input'),
        };

        let db, auth, userId = null;
        let devicesCollectionRef = null;
        let currentDevices = []; // Store the current state of devices for display logic
        
        // --- Utility Functions ---

        function displayError(message) {
            console.error(message);
            DOM.error.textContent = message;
            DOM.error.classList.remove('hidden');
        }

        function clearError() {
            DOM.error.classList.add('hidden');
            DOM.error.textContent = '';
        }

        function getUserInfo() {
            const name = DOM.nameInput.value.trim();
            const email = DOM.emailInput.value.trim();
            const returnDate = DOM.returnDateInput.value;
            
            if (!name || !email || !returnDate) {
                displayError("Please enter your Full Name, Email, and the Expected Return Date to check out a device.");
                return null;
            }
            return { name, email, returnDate };
        }
        
        // --- Firestore Operations ---
        
        async function updateDeviceStatus(deviceId, status) {
            // Added explicit userId check for checkout
            if (status === 'checked_out' && !userId) {
                return displayError("Authentication is pending. Please wait a moment before checking out a device.");
            }
            if (!devicesCollectionRef) return displayError("Database not initialized.");
            
            const isCheckingOut = status === 'checked_out';
            let updateData = { status: status };
            
            if (isCheckingOut) {
                const userInfo = getUserInfo();
                if (!userInfo) return; // Error handled by getUserInfo
                
                updateData.checkedOutBy = userId;
                updateData.checkedOutByUserName = userInfo.name;
                updateData.expectedReturnDate = userInfo.returnDate; // New field
                updateData.checkedOutAt = new Date().toISOString();
                
            } else {
                // Check In logic: Clear all checkout fields
                updateData.checkedOutBy = null;
                updateData.checkedOutByUserName = null;
                updateData.checkedOutByUserEmail = null;
                updateData.expectedReturnDate = null; // Clear new field
                updateData.checkedOutAt = null;
            }

            try {
                const docRef = doc(db, devicesCollectionRef.path, deviceId);
                await updateDoc(docRef, updateData);
                clearError();
            } catch (e) {
                displayError(`Error updating device: ${e.message}`);
            }
        }

        // --- Rendering Logic ---

        function createDeviceCard(device) {
            const isCheckedOut = device.status === 'checked_out';
            const isCheckedOutByMe = isCheckedOut && device.checkedOutBy === userId;
            const isPastDue = isCheckedOut && device.expectedReturnDate && (new Date(device.expectedReturnDate) < new Date());

            const statusColor = isPastDue ? 'bg-warning' : (isCheckedOut ? 'bg-danger' : 'bg-success');
            const statusText = isPastDue ? 'OVERDUE' : (isCheckedOut ? 'Checked Out' : 'Available');
            
            const buttonText = isCheckedOutByMe ? 'Check In' : 'Check Out';
            const buttonClass = isCheckedOutByMe ? 'bg-danger hover:bg-red-600' : 'bg-primary hover:bg-primary-600';
            // Disable button if it's checked out by someone else AND we are authenticated
            // If userId is null (pending auth), we allow the button to remain active until updateDoc fails inside updateDeviceStatus
            const buttonDisabled = isCheckedOut && !isCheckedOutByMe && userId !== null; 

            const card = document.createElement('div');
            card.className = 'p-5 bg-white border border-gray-200 rounded-xl shadow-lg flex flex-col sm:flex-row items-start sm:items-center justify-between transition duration-200';
            
            const statusIndicator = `
                <span class="w-3 h-3 rounded-full ${statusColor} mr-4 mt-2 flex-shrink-0" aria-label="Device Status"></span>
                <div class="flex flex-col">
                    <span class="text-xl font-bold text-gray-800">${device.name}</span>
                    <span class="text-sm font-medium text-gray-600 flex items-center">
                        Status: <span class="ml-1 font-bold ${isCheckedOut ? (isPastDue ? 'text-warning' : 'text-danger') : 'text-success'}">${statusText}</span>
                    </span>
                    ${isCheckedOut ? `
                        <div class="text-sm text-gray-600 mt-2 p-3 border border-gray-100 rounded-lg bg-gray-50 max-w-sm">
                            <p><span class="font-semibold">Checked Out By:</span> ${device.checkedOutByUserName || 'Another User'}</p>
                        </div>
                    ` : ''}
                </div>
            `;
            
            const buttonSection = `
                <button
                    id="btn-${device.id}"
                    class="py-2 px-4 rounded-lg text-white font-medium transition duration-150 transform hover:scale-[1.02] disabled:opacity-50 disabled:cursor-not-allowed ${buttonClass} mt-3 sm:mt-0"
                    ${buttonDisabled ? 'disabled' : ''}
                >
                    ${buttonText}
                </button>
            `;

            card.innerHTML = `<div class="flex items-start mb-3 sm:mb-0">${statusIndicator}</div> ${buttonSection}`;


            // Attach click handler
            const button = card.querySelector(`#btn-${device.id}`);
            button.addEventListener('click', () => {
                
                // If the user tries to interact while authentication is pending:
                if (userId === null) {
                    displayError("Authentication is currently pending. Please wait a moment for the connection to finalize.");
                    if (isCheckedOutByMe) return; // Prevent check-in until we know who the user is.
                }

                if (isCheckedOutByMe) {
                    // Case 1: Check In (NAME CONFIRMATION LOGIC)
                    const currentUserName = DOM.nameInput.value.trim();
                    const requiredUserName = device.checkedOutByUserName;

                    if (!currentUserName) {
                         displayError(`To check in "${device.name}", please **re-enter your full name** in the "Your Information" section above to confirm your return.`);
                         return;
                    }
                    
                    if (currentUserName === requiredUserName) {
                        updateDeviceStatus(device.id, 'available');
                    } else {
                        displayError(`Check-in failed for "${device.name}". The name you entered ("${currentUserName}") does not match the name recorded for this checkout ("${requiredUserName}").`);
                    }

                } else if (!isCheckedOut) {
                    // Case 2: Check Out (Device is available)
                    updateDeviceStatus(device.id, 'checked_out');
                } else {
                    // Case 3: Attempting to Check Out a device that is already checked out by someone else
                    displayError(`Device "${device.name}" is not available for checkout. It is currently checked out by ${device.checkedOutByUserName || 'another user'}.`);
                }
            });

            return card;
        }

        function renderDeviceList(devices) {
            DOM.list.innerHTML = '';
            
            const spinner = document.getElementById('loading-spinner');
            if(spinner) spinner.remove();

            if (devices.length === 0) {
                const message = document.createElement('p');
                message.className = 'text-center text-gray-500 py-10 italic bg-gray-50 rounded-lg border border-dashed border-gray-200';
                message.textContent = "No devices found in the system. Add devices via the Firestore console."; 
                DOM.list.appendChild(message);
                return;
            }
            
            // Sort: Available first, then Checked Out, then Overdue
            devices.sort((a, b) => {
                const statusA = a.status;
                const statusB = b.status;
                
                if (statusA === 'available' && statusB !== 'available') return -1;
                if (statusB === 'available' && statusA !== 'available') return 1;

                // Secondary sort: Overdue devices should be near the top
                const isADue = a.expectedReturnDate && (new Date(a.expectedReturnDate) < new Date());
                const isBDue = b.expectedReturnDate && (new Date(b.expectedReturnDate) < new Date());

                if (isADue && !isBDue) return -1;
                if (isBDue && !isADue) return 1;

                return 0; // Maintain existing order otherwise
            }); 

            devices.forEach(device => DOM.list.appendChild(createDeviceCard(device)));
        }


        // --- Main Initialization and Authentication ---

        async function initFirebase() {
            if (!Object.keys(firebaseConfig).length) {
                // Only show this error if the environment config was truly empty
                return displayError("Firebase configuration is missing. Cannot start application.");
            }

            try {
                // setLogLevel('Debug'); // Uncomment this for console debugging
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // 1. Setup Firestore Collection and Listener (Independent of Auth State)
                const collectionPath = `artifacts/${appId}/public/data/devices`;
                devicesCollectionRef = collection(db, collectionPath);
                startRealtimeListener();
                
                // 2. Perform Authentication in the background
                const authenticateUser = async () => {
                    try {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch(e) {
                        console.error("Authentication failed:", e);
                        // The API Key error should be resolved now, but we keep this handler.
                    }
                };
                authenticateUser();

                // 3. Set up Auth State Observer - only used to set userId for interaction logic
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // For debugging purposes only
                        console.log("Authenticated with user ID:", userId); 
                    } else {
                        userId = null;
                        // This handles cases where auth fails (like the API Key error, which should be fixed now)
                    }
                    clearError();
                });

            } catch (e) {
                const spinner = document.getElementById('loading-spinner');
                if(spinner) spinner.remove();
                displayError(`Application Error: Cannot initialize database. Details: ${e.message}`);
            }
        }
        
        function startRealtimeListener() {
            if (!devicesCollectionRef) return;
            
            const devicesQuery = query(devicesCollectionRef);
            
            onSnapshot(devicesQuery, (snapshot) => {
                const devices = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                }));

                currentDevices = devices; 
                renderDeviceList(devices);
            }, (err) => {
                // This is the error handler for "Missing or insufficient permissions"
                // It should disappear once authentication succeeds.
                displayError(`Real-time Listener Error: ${err.message}`);
            });
        }

        // Start the application
        window.onload = initFirebase;
    </script>
</body>
</html>


