<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Persistent To-Do List</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind to use Inter font and custom colors -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        'primary-500': '#4f46e5',
                        'primary-600': '#4338ca',
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar for better aesthetics */
        body::-webkit-scrollbar {
            width: 8px;
        }
        body::-webkit-scrollbar-thumb {
            background-color: #9ca3af;
            border-radius: 4px;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
        .task-enter {
            opacity: 0;
            transform: translateY(-10px);
        }
        .task-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 300ms, transform 300ms;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">
    <div class="max-w-xl mx-auto bg-white shadow-2xl rounded-xl p-6 sm:p-8">
        <h1 class="text-4xl font-extrabold text-gray-800 mb-2">Persistent To-Do List</h1>
        <p id="user-info" class="text-sm text-gray-500 mb-6 border-b pb-4">
            <span class="font-semibold text-primary-500">Connecting...</span>
        </p>

        <div id="error-message" class="hidden p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg" role="alert"></div>

        <form id="add-task-form" class="flex gap-3 mb-8">
            <input
                type="text"
                id="new-task-input"
                placeholder="What needs to be done?"
                class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-primary-500 focus:border-primary-500 transition duration-150 disabled:bg-gray-50"
                disabled
                aria-label="New task input"
            />
            <button
                type="submit"
                id="add-task-button"
                class="bg-primary-500 text-white p-3 rounded-lg shadow-md hover:bg-primary-600 transition duration-150 transform hover:scale-105 disabled:bg-primary-400 flex items-center justify-center"
                disabled
                aria-label="Add task"
            >
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 mr-0 sm:mr-1">
                    <circle cx="12" cy="12" r="10"/><path d="M12 8v8M8 12h8"/>
                </svg>
                <span class="hidden sm:inline">Add Task</span>
            </button>
        </form>

        <ul id="todo-list" class="space-y-3">
            <li id="loading-spinner" class="flex justify-center items-center py-10">
                <svg class="animate-spin h-8 w-8 text-primary-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </li>
        </ul>
    </div>

    <!-- Firebase SDK Imports and Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, doc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // UI elements
        const userInfoEl = document.getElementById('user-info');
        const errorEl = document.getElementById('error-message');
        const listEl = document.getElementById('todo-list');
        const formEl = document.getElementById('add-task-form');
        const inputEl = document.getElementById('new-task-input');
        const buttonEl = document.getElementById('add-task-button');
        const loadingSpinner = document.getElementById('loading-spinner');

        let db, auth, userId = null;
        let todoCollectionRef = null;

        // --- Utility Functions ---

        function displayError(message) {
            console.error(message);
            errorEl.textContent = message;
            errorEl.classList.remove('hidden');
        }

        function clearError() {
            errorEl.classList.add('hidden');
            errorEl.textContent = '';
        }

        function enableInput(enabled) {
            inputEl.disabled = !enabled;
            buttonEl.disabled = !enabled;
            if (enabled) {
                buttonEl.classList.remove('disabled:bg-primary-400');
            } else {
                buttonEl.classList.add('disabled:bg-primary-400');
            }
        }

        // --- Core Firebase Initialization ---

        async function initFirebase() {
            if (!firebaseConfig) {
                displayError("Firebase configuration is missing.");
                return;
            }

            try {
                setLogLevel('Debug'); // Enable debug logging for Firebase
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                userInfoEl.innerHTML = `<span class="font-semibold text-primary-500">Authenticating...</span>`;
                
                // 1. Authenticate the user
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // 2. Set up auth state observer
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        // MANDATORY Firestore path for private user data
                        const collectionPath = `artifacts/${appId}/users/${userId}/todos`;
                        todoCollectionRef = collection(db, collectionPath);
                        
                        userInfoEl.innerHTML = `<span class="font-semibold text-primary-500">User ID:</span> ${userId}`;
                        enableInput(true);
                        clearError();
                        
                        // 3. Start real-time listener after successful auth
                        startRealtimeListener();

                    } else {
                        userId = null;
                        userInfoEl.innerHTML = `<span class="font-semibold text-red-500">Not signed in. Cannot save data.</span>`;
                        enableInput(false);
                    }
                });

            } catch (e) {
                displayError(`Firebase initialization or authentication failed: ${e.message}`);
                loadingSpinner.remove();
            }
        }

        // --- Firestore Operations ---

        function startRealtimeListener() {
            if (!todoCollectionRef) return;

            const todosQuery = query(todoCollectionRef);

            onSnapshot(todosQuery, (snapshot) => {
                loadingSpinner.remove();
                
                const todos = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data(),
                }));

                renderTodoList(todos.sort((a, b) => new Date(a.createdAt) - new Date(b.createdAt)));

            }, (err) => {
                displayError(`Real-time data error: ${err.message}`);
            });
        }

        async function addTask(text) {
            if (!todoCollectionRef || !text.trim()) return;
            try {
                await addDoc(todoCollectionRef, {
                    text: text.trim(),
                    completed: false,
                    createdAt: new Date().toISOString(),
                });
                inputEl.value = ''; // Clear input on success
            } catch (e) {
                displayError(`Error adding task: ${e.message}`);
            }
        }

        async function toggleComplete(id, currentStatus) {
            if (!todoCollectionRef) return;
            try {
                const docRef = doc(db, todoCollectionRef.path, id);
                await updateDoc(docRef, {
                    completed: !currentStatus
                });
            } catch (e) {
                displayError(`Error updating task: ${e.message}`);
            }
        }

        async function deleteTask(id) {
            if (!todoCollectionRef) return;
            try {
                const docRef = doc(db, todoCollectionRef.path, id);
                await deleteDoc(docRef);
            } catch (e) {
                displayError(`Error deleting task: ${e.message}`);
            }
        }

        // --- UI Rendering ---

        function createTodoItem(todo) {
            const li = document.createElement('li');
            li.id = `todo-${todo.id}`;
            li.className = `flex items-center justify-between p-4 rounded-lg shadow-sm transition duration-200 task-enter-active ${
                todo.completed ? 'bg-green-50 border-l-4 border-green-400' : 'bg-white border-l-4 border-gray-200 hover:shadow-md'
            }`;

            li.innerHTML = `
                <span
                    class="flex-grow text-lg ${
                        todo.completed ? 'line-through text-gray-500' : 'text-gray-800'
                    } break-words cursor-pointer"
                    aria-label="${todo.text}"
                >
                    ${todo.text}
                </span>

                <div class="flex space-x-2 ml-4">
                    <button
                        class="toggle-btn p-2 rounded-full transition duration-150 ${
                            todo.completed
                                ? 'text-gray-400 hover:text-green-600'
                                : 'text-green-600 hover:text-green-700 hover:bg-green-100'
                        }"
                        data-id="${todo.id}"
                        data-status="${todo.completed}"
                        aria-label="${todo.completed ? "Mark as incomplete" : "Mark as complete"}"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                            <path d="M9 11l3 3L22 4"/>
                        </svg>
                    </button>
                    <button
                        class="delete-btn p-2 rounded-full text-red-500 hover:bg-red-100 hover:text-red-600 transition duration-150"
                        data-id="${todo.id}"
                        aria-label="Delete task"
                    >
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6">
                            <path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                        </svg>
                    </button>
                </div>
            `;
            
            // Attach event listeners to the new elements
            li.querySelector('.toggle-btn').addEventListener('click', (e) => {
                const id = e.currentTarget.getAttribute('data-id');
                const status = e.currentTarget.getAttribute('data-status') === 'true';
                toggleComplete(id, status);
            });

            li.querySelector('.delete-btn').addEventListener('click', (e) => {
                deleteTask(e.currentTarget.getAttribute('data-id'));
            });

            li.querySelector('span').addEventListener('click', (e) => {
                const id = li.querySelector('.toggle-btn').getAttribute('data-id');
                const status = li.querySelector('.toggle-btn').getAttribute('data-status') === 'true';
                toggleComplete(id, status);
            });

            return li;
        }

        function renderTodoList(todos) {
            listEl.innerHTML = ''; // Clear existing list
            
            if (todos.length === 0) {
                const emptyMessage = document.createElement('p');
                emptyMessage.className = 'text-center text-gray-500 py-10 italic';
                emptyMessage.textContent = userId ? "No tasks yet! Add one above." : "Waiting for connection...";
                listEl.appendChild(emptyMessage);
                return;
            }

            todos.forEach(todo => {
                listEl.appendChild(createTodoItem(todo));
            });
        }

        // --- Event Listeners ---

        formEl.addEventListener('submit', (e) => {
            e.preventDefault();
            const text = inputEl.value;
            if (text.trim() && userId) {
                addTask(text);
            }
        });

        // Initialize on window load
        window.onload = initFirebase;

    </script>
</body>
</html>
